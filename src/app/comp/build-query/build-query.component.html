<div class="create-page-wrapper">
  <div class="dashboard-form-card">
    <h2>Build Query</h2>

    @if (error) {
    <div class="alert alert-error">{{ error }}</div>
    }

    @if (success) {
    <div class="alert alert-success">{{ success }}</div>
    }

    <form [formGroup]="buildQueryForm">
      <!-- Title -->
      <div class="form-group">
        <label for="title">Title <span class="required">*</span></label>
        <input
          id="title"
          type="text"
          formControlName="title"
          placeholder="e.g., Monthly Sales Report"
          [class.is-invalid]="
            buildQueryForm.get('title')?.invalid &&
            buildQueryForm.get('title')?.touched
          "
        />
        @if (
          buildQueryForm.get('title')?.invalid &&
          buildQueryForm.get('title')?.touched
        ) {
        <small class="error-text"
          >Title is required (min 3 characters)</small
        >
        }
      </div>

      <!-- Description -->
      <div class="form-group">
        <label for="description">Description <span class="required">*</span></label>
        <textarea
          id="description"
          formControlName="description"
          placeholder="What does this query do?"
          rows="2"
          [class.is-invalid]="
            buildQueryForm.get('description')?.invalid &&
            buildQueryForm.get('description')?.touched
          "
        ></textarea>
        @if (
          buildQueryForm.get('description')?.invalid &&
          buildQueryForm.get('description')?.touched
        ) {
        <small class="error-text">Description is required</small>
        }
      </div>

      <!-- Data Source Dropdown with Sync Button -->
      <div class="form-group">
        <label for="dataSource">Data Source <span class="required">*</span></label>
        <div class="datasource-container">
          @if (loadingDataSources) {
          <div class="loading">Loading data sources...</div>
          } @else {
          <select
            id="dataSource"
            formControlName="dataSource"
            (change)="onDataSourceChange($any($event.target).value)"
            [class.is-invalid]="buildQueryForm.get('dataSource')?.invalid && buildQueryForm.get('dataSource')?.touched"
          >
            <option value="">Select a data source...</option>
            @for (ds of dataSources; track ds._id) {
            <option [value]="ds._id">
              {{ ds.name }} (Metabase ID: {{ ds.metabaseDbId || 'Not synced' }})
            </option>
            }
          </select>
          <!-- begin add dataSource button -->
          <div tabindex="0" class="plusButton" (click)="navigateToCreateDataSource()" (keydown.enter)="navigateToCreateDataSource()">
          <svg class="plusIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30">
              <g mask="url(#mask0_21_345)">
                <path d="M13.75 23.75V16.25H6.25V13.75H13.75V6.25H16.25V13.75H23.75V16.25H16.25V23.75H13.75Z"></path>
              </g>
            </svg>
          </div>
          <!-- end add dataSource button -->

          @if (selectedDataSourceId) {
          <button
            type="button"
            class="btn-sync"
            (click)="syncDataSource(selectedDataSourceId)"
            [disabled]="getSyncStatus(selectedDataSourceId) === 'syncing'"
          >
            @if (getSyncStatus(selectedDataSourceId) === 'syncing') {
            <span class="spinner"></span>
            Syncing...
            } @else if (getSyncStatus(selectedDataSourceId) === 'synced') {
            <span class="synced-check">✓ Synced</span>
            } @else {
            Sync
            }
          </button>
          }
          }

          @if (buildQueryForm.get('dataSource')?.invalid && buildQueryForm.get('dataSource')?.touched) {
          <small class="error-text">Data Source is required</small>
          }
        </div>
      </div>

      <!-- Query Type -->
      <div class="form-group">
        <label for="type">Query Type <span class="required">*</span></label>
        <select
          id="type"
          formControlName="type"
          [class.is-invalid]="
            buildQueryForm.get('type')?.invalid &&
            buildQueryForm.get('type')?.touched
          "
        >
          <option value="builder">Builder</option>
          <option value="native">Native SQL</option>
        </select>
      </div>

      <!-- BUILDER MODE: Table Dropdown -->
      @if (queryType === 'builder') {
      <div class="form-group">
        <label for="tableId">Select Table <span class="required">*</span></label>
        @if (loadingTables) {
        <div class="loading">Loading tables...</div>
        } @else if (tables.length === 0 && selectedDataSourceId) {
        <div class="info-message">
          No tables found. Click the Sync button above to sync your data source
          to Metabase.
        </div>
        } @else {
        <select
          id="tableId"
          formControlName="tableId"
          [class.is-invalid]="
            buildQueryForm.get('tableId')?.invalid &&
            buildQueryForm.get('tableId')?.touched
          "
          [disabled]="tables.length === 0"
        >
          <option value="">Choose a table...</option>
          @for (table of tables; track table.id) {
          <option [value]="table.id">
            {{ table.displayName }} ({{ table.name }})
          </option>
          }
        </select>
        }
        @if (
          buildQueryForm.get('tableId')?.invalid &&
          buildQueryForm.get('tableId')?.touched
        ) {
        <small class="error-text">Table is required</small>
        }
      </div>

      <!-- Aggregation (Builder only) -->
      <div class="form-group">
        <label for="aggregation">Aggregation</label>
        <select id="aggregation" formControlName="aggregation">
          <option value="none">None</option>
          <option value="count">Count</option>
          <option value="sum">Sum</option>
          <option value="avg">Average</option>
        </select>
      </div>
      }

      <!-- NATIVE MODE: SQL Query Input -->
      @if (queryType === 'native') {
      <div class="form-group">
        <label for="sqlQuery">SQL Query <span class="required">*</span></label>
        <textarea
          id="sqlQuery"
          formControlName="sqlQuery"
          placeholder="SELECT * FROM table_name WHERE condition = ?"
          rows="8"
          [class.is-invalid]="
            buildQueryForm.get('sqlQuery')?.invalid &&
            buildQueryForm.get('sqlQuery')?.touched
          "
        ></textarea>
        @if (
          buildQueryForm.get('sqlQuery')?.invalid &&
          buildQueryForm.get('sqlQuery')?.touched
        ) {
        <small class="error-text">SQL Query is required</small>
        }
      </div>
      }
      
      <!-- Chart Type Selection -->
      <div class="form-group">
        <label for="chartType">Chart Type <span class="required">*</span></label>
        <select
          id="chartType"
          formControlName="chartType"
          [class.is-invalid]="
            buildQueryForm.get('chartType')?.invalid &&
            buildQueryForm.get('chartType')?.touched
          "
        >
          <option value="bar">Bar Chart</option>
          <option value="line">Line Chart</option>
          <option value="area">Area Chart</option>
          <option value="pie">Pie Chart</option>
          <option value="donut">Donut Chart</option>
          <option value="radar">Radar Chart</option>
          <option value="heatmap">Heatmap</option>
          <option value="scatter">Scatter Plot</option>
          <option value="mixed">Mixed Chart</option>
        </select>
        @if (
          buildQueryForm.get('chartType')?.invalid &&
          buildQueryForm.get('chartType')?.touched
        ) {
        <small class="error-text">Chart Type is required</small>
        }
      </div>

      <!-- JSON Preview -->
      @if (getQueryDefinitionDisplay()) {
      <div class="json-preview">
        <button
          type="button"
          (click)="toggleJsonPreview()"
          class="toggle-json"
        >
          {{ showJsonPreview ? 'Hide' : 'Show' }} View Generated Query JSON
        </button>
        @if (showJsonPreview) {
        <pre class="json-content">{{ getQueryDefinitionDisplay() }}</pre>
        }
      </div>
      }

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn-reset" (click)="onReset()">
          Reset
        </button>
        <button
          type="button"
          class="btn-create"
          (click)="createQuery()"
          [disabled]="buildQueryForm.invalid || loading || !currentUserId"
        >
          @if (loading) {
          <span class="spinner"></span>
          }
          {{ loading ? 'Creating...' : 'Create Query' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modern Dashboard Assignment Modal -->
@if (showDashboardModal) {
<div class="modal-overlay" (click)="closeDashboardModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <div>
        <h3>Add to Dashboard</h3>
        <p class="modal-subtitle">Assign your query "{{ createdQuery?.title }}" to a dashboard</p>
      </div>
      <button class="modal-close" (click)="closeDashboardModal()">✕</button>
    </div>

    <!-- Body -->
    <div class="modal-body">
      @if (dashboardError) {
      <div class="alert alert-error">{{ dashboardError }}</div>
      }

      @if (loadingDashboards) {
      <div class="loading-dashboards">
        <div class="spinner"></div>
        <p>Loading your dashboards...</p>
      </div>
      } @else if (dashboards.length === 0) {
      <div class="no-dashboards">
        <p>No dashboards found. Create one first to add this query.</p>
      </div>
      } @else {
      <div class="dashboard-list">
        @for (dashboard of dashboards; track dashboard._id) {
        <label class="dashboard-item" [class.selected]="selectedDashboardId === dashboard._id">
          <input
            type="radio"
            name="dashboard"
            [value]="dashboard._id"
            (change)="selectedDashboardId = $any($event.target).value"
          />
          <div class="dashboard-card">
            <div class="dashboard-icon"><svg viewBox="0 0 24 24" fill="currentColor">
            <rect x="3" y="3" width="7" height="7"></rect>
            <rect x="14" y="3" width="7" height="7"></rect>
            <rect x="14" y="14" width="7" height="7"></rect>
            <rect x="3" y="14" width="7" height="7"></rect>
          </svg></div>
            <div class="dashboard-info">
              <h4>{{ dashboard.name }}</h4>
              @if (dashboard.description) {
              <p class="dashboard-desc">{{ dashboard.description }}</p>
              }
            </div>
          </div>
        </label>
        }
      </div>
      }
    </div>

    <!-- Footer -->
    <div class="modal-footer">
      <button
        type="button"
        class="btn-secondary"
        (click)="skipDashboardAssignment()"
      >
        Skip for Now
      </button>
      <button
        type="button"
        class="btn-primary"
        (click)="assignQueryToDashboard()"
        [disabled]="!selectedDashboardId || assigningToDashboard"
      >
        @if (assigningToDashboard) {
        <span class="spinner"></span>
        }
        {{ assigningToDashboard ? 'Adding...' : 'Add to Dashboard' }}
      </button>
    </div>
  </div>
</div>
}

<!-- Success Message with Sync Status -->
@if (isCreated && createdQuery) {
<div class="query-info">
  <div class="query-header">
    <h3>Query Created Successfully!</h3>
  </div>

  <div class="info-item">
    <strong>Query ID:</strong>
    <code>{{ createdQuery._id }}</code>
  </div>

  <div class="info-item">
    <strong>Title:</strong>
    <span>{{ createdQuery.title }}</span>
  </div>

  <div class="info-item">
    <strong>Type:</strong>
    <span class="badge" [ngClass]="createdQuery.type === 'native' ? 'badge-native' : 'badge-builder'">
      {{ createdQuery.type === 'native' ? 'SQL (Native)' : 'Builder' }}
    </span>
  </div>

  <div class="info-item">
    <strong>Chart Type:</strong>
    <span class="badge badge-chart">{{ createdQuery.chartType || 'bar' }}</span>
  </div>

  @if (isCreated && createdQuery) {
  <div class="query-created-card">
    <h3>Query Created Successfully!</h3>
    <p><strong>{{ createdQuery.title }}</strong></p>
    
    @if (createdQuery.metabaseCardId) {
      <p class="success-text">
        Synced to Metabase (Card ID: {{ createdQuery.metabaseCardId }})
      </p>
    } @else {
      <p class="warning-text">
        Not yet synced to Metabase
      </p>
      
      <button 
        type="button" 
        class="btn-retry-sync"
        (click)="retryMetabaseSync(createdQuery._id)"
        [disabled]="retryingQueryId === createdQuery._id">
        @if (retryingQueryId === createdQuery._id) {
          <span class="spinner"></span> Retrying...
        } @else {
          Retry Metabase Sync
        }
      </button>
    }
  </div>
  }

  <div class="info-item">
    <strong>Created At:</strong>
    <span>{{ createdQuery.createdAt | date: 'medium' }}</span>
  </div>

  <div class="info-divider"></div>

  <div class="action-buttons">
    <button type="button" class="btn-create-another" (click)="onReset()">
      Create Another Query
    </button>
  </div>
</div>
}