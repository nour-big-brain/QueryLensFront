<div class="create-page-wrapper">
  <div class="dashboard-form-card">
    <h2>Build Query</h2>

    @if (error) {
      <div class="alert alert-error">
        {{ error }}
      </div>
    }

    @if (success) {
      <div class="alert alert-success">
        {{ success }}
      </div>
    }

    <form [formGroup]="buildQueryForm" (ngSubmit)="createQuery()">
      <div class="form-group">
        <label for="title">Title <span class="required">*</span></label>
        <input
          id="title"
          type="text"
          formControlName="title"
          placeholder="Enter query title"
          [class.is-invalid]="buildQueryForm.get('title')?.invalid && buildQueryForm.get('title')?.touched"
        />
        @if (buildQueryForm.get('title')?.invalid && buildQueryForm.get('title')?.touched) {
          <small class="error-text">Title is required (min 3 characters)</small>
        }
      </div>

      <div class="form-group">
        <label for="description">Description <span class="required">*</span></label>
        <textarea
          id="description"
          formControlName="description"
          placeholder="Enter query description"
          rows="3"
          [class.is-invalid]="buildQueryForm.get('description')?.invalid && buildQueryForm.get('description')?.touched"
        ></textarea>
        @if (buildQueryForm.get('description')?.invalid && buildQueryForm.get('description')?.touched) {
          <small class="error-text">Description is required</small>
        }
      </div>

      <div class="form-group">
        <label for="dataSource">Data Source ID <span class="required">*</span></label>
        <input
          id="dataSource"
          type="text"
          formControlName="dataSource"
          placeholder="Enter data source MongoDB ID"
          [class.is-invalid]="buildQueryForm.get('dataSource')?.invalid && buildQueryForm.get('dataSource')?.touched"
        />
        @if (buildQueryForm.get('dataSource')?.invalid && buildQueryForm.get('dataSource')?.touched) {
          <small class="error-text">Data Source ID is required</small>
        }
      </div>

      <div class="form-group">
        <label for="type">Query Type <span class="required">*</span></label>
        <select
          id="type"
          formControlName="type"
          [class.is-invalid]="buildQueryForm.get('type')?.invalid && buildQueryForm.get('type')?.touched"
        >
          <option value="builder">Builder</option>
          <option value="native">Native SQL</option>
          <option value="ai">AI Generated</option>
        </select>
        @if (buildQueryForm.get('type')?.invalid && buildQueryForm.get('type')?.touched) {
          <small class="error-text">Query Type is required</small>
        }
      </div>

      <div class="form-group">
        <label for="queryDefinition">Query Definition (JSON) <span class="required">*</span></label>
        <textarea
          id="queryDefinition"
          formControlName="queryDefinition"
          placeholder='{"source-table": 1}'
          rows="6"
          [class.is-invalid]="buildQueryForm.get('queryDefinition')?.invalid && buildQueryForm.get('queryDefinition')?.touched"
        ></textarea>
        @if (buildQueryForm.get('queryDefinition')?.invalid && buildQueryForm.get('queryDefinition')?.touched) {
          <small class="error-text">Query Definition is required (must be valid JSON)</small>
        }
      </div>

      <div class="form-group">
        <label for="userId">User ID (Creator) <span class="required">*</span></label>
        <input
          id="userId"
          type="text"
          formControlName="userId"
          placeholder="Enter user MongoDB ID"
          [class.is-invalid]="buildQueryForm.get('userId')?.invalid && buildQueryForm.get('userId')?.touched"
        />
        @if (buildQueryForm.get('userId')?.invalid && buildQueryForm.get('userId')?.touched) {
          <small class="error-text">User ID is required</small>
        }
      </div>

      <div class="form-actions">
        <button type="button" class="btn-reset" (click)="onReset()">
          Reset
        </button>
        <button
          type="submit"
          class="btn-create"
          [disabled]="buildQueryForm.invalid || loading"
        >
          @if (loading) {
            <span class="spinner"></span>
          }
          {{ loading ? 'Creating...' : 'Create Query' }}
        </button>
      </div>

      @if (isCreated && createdQuery) {
        <div class="query-info">
          <h3>Query Created Successfully!</h3>
          <div class="info-item">
            <strong>Query ID:</strong>
            <code>{{ createdQuery._id }}</code>
          </div>
          <div class="info-item">
            <strong>Title:</strong>
            <span>{{ createdQuery.title }}</span>
          </div>
          @if (createdQuery.metabaseCardId) {
            <div class="info-item">
              <strong>Metabase Card ID:</strong>
              <code>{{ createdQuery.metabaseCardId }}</code>
            </div>
          }
          <div class="info-item">
            <strong>Created At:</strong>
            <span>{{ createdQuery.createdAt | date: 'medium' }}</span>
          </div>
        </div>
      }
    </form>
  </div>
</div>