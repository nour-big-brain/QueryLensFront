<div class="datasource-container">
  <!-- Subtle SVG Background -->
  <div class="svg-background">
    <svg preserveAspectRatio="xMidYMid slice" viewBox="0 0 1440 900" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="dsGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#7c3aed;stop-opacity:0.06" />
          <stop offset="100%" style="stop-color:#6366f1;stop-opacity:0.04" />
        </linearGradient>
        <linearGradient id="dsGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#6366f1;stop-opacity:0.05" />
          <stop offset="100%" style="stop-color:#3b82f6;stop-opacity:0.03" />
        </linearGradient>
      </defs>
      <circle cx="100" cy="100" r="200" fill="url(#dsGrad1)" />
      <circle cx="150" cy="80" r="150" fill="url(#dsGrad2)" opacity="0.5" />
      <circle cx="1340" cy="120" r="220" fill="url(#dsGrad2)" />
      <circle cx="1300" cy="100" r="160" fill="url(#dsGrad1)" opacity="0.6" />
      <path d="M 0 450 Q 360 420, 720 450 T 1440 450" stroke="#7c3aed" stroke-width="1" fill="none" opacity="0.08" />
    </svg>
  </div>

  <!-- Content -->
  <div class="datasource-content">
    <div class="datasource-header">
      <h1>Data Source Manager</h1>
      <p>Connect and manage your data sources securely</p>
    </div>

    <!-- Alerts -->
    @if (error) {
      <div class="alert alert-error">
        {{ error }}
        <button type="button" class="alert-close" (click)="error = null">×</button>
      </div>
    }

    @if (success) {
      <div class="alert alert-success">
        {{ success }}
        <button type="button" class="alert-close" (click)="success = null">×</button>
      </div>
    }

    <div class="datasource-grid">
      <!-- Form Section -->
      <div class="form-section">
        <div class="card-header">
          <h2>Create Data Source</h2>
        </div>

        <form [formGroup]="form" class="datasource-form">
          <div class="form-group">
            <label for="name">Data Source Name</label>
            <input type="text" id="name" formControlName="name" placeholder="e.g., Production DB"
              [class.is-invalid]="form.get('name')?.invalid && form.get('name')?.touched">
            @if (form.get('name')?.invalid && form.get('name')?.touched) {
              <span class="error-text">Name required (min 3 chars)</span>
            }
          </div>

          <div class="form-group">
            <label for="type">Database Type</label>
            <select id="type" formControlName="type" class="form-select">
              <option value="sql">SQL</option>
              <option value="nosql">NoSQL</option>
              <option value="api">API</option>
            </select>
          </div>

          <div class="form-divider">Connection Details</div>

          <div class="form-row">
            <div class="form-group">
              <label for="host">Host</label>
              <input type="text" id="host" formControlName="host" placeholder="localhost"
                [class.is-invalid]="form.get('host')?.invalid && form.get('host')?.touched">
            </div>

            <div class="form-group">
              <label for="port">Port</label>
              <input type="number" id="port" formControlName="port" placeholder="5432"
                [class.is-invalid]="form.get('port')?.invalid && form.get('port')?.touched">
            </div>
          </div>

          <div class="form-group">
            <label for="database">Database Name</label>
            <input type="text" id="database" formControlName="database" placeholder="mydb"
              [class.is-invalid]="form.get('database')?.invalid && form.get('database')?.touched">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="username">Username</label>
              <input type="text" id="username" formControlName="username" placeholder="admin"
                [class.is-invalid]="form.get('username')?.invalid && form.get('username')?.touched">
            </div>

            <div class="form-group">
              <label for="password">Password</label>
              <input type="password" id="password" formControlName="password" placeholder="••••••••"
                [class.is-invalid]="form.get('password')?.invalid && form.get('password')?.touched">
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-primary" (click)="createDataSource()" [disabled]="loading">
              @if (loading) {
                <span class="spinner"></span>
                Creating...
              } @else {
                @if (isMissingCriticalFields) {
                  Try Anyway
                } @else {
                  Create Data Source
                }
              }
            </button>

            <button type="button" class="btn btn-secondary" (click)="resetForm()">
              Clear
            </button>
          </div>

          @if (isMissingCriticalFields && !loading) {
            <div class="warning-text">⚠️ Warning: Some fields missing. Connection may fail.</div>
          }
        </form>
      </div>

      <!-- Details Section -->
      <div class="details-section">
        @if (dataSource) {
          <div class="card-header">
            <h2>Data Source Details</h2>
          </div>

          <div class="details-card">
            <div class="detail-item">
              <span class="label">Name:</span>
              <span class="value">{{ dataSource.name }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Type:</span>
              <span class="value badge">{{ dataSource.type }}</span>
            </div>

            <div class="detail-item">
              <span class="label">Data Source ID:</span>
              <code>{{ dataSource._id }}</code>
            </div>

            @if (dataSource.metabaseDbId) {
              <div class="detail-item">
                <span class="label">Metabase ID:</span>
                <code>{{ dataSource.metabaseDbId }}</code>
              </div>
            }

            <div class="detail-item">
              <span class="label">Connection:</span>
              <p class="connection-info">
                {{ dataSource.connectionCredentials.host }}:{{ dataSource.connectionCredentials.port }}/{{ dataSource.connectionCredentials.database }}
              </p>
            </div>

            @if (dataSource.createdAt) {
              <div class="detail-item">
                <span class="label">Created:</span>
                <span class="value">{{ dataSource.createdAt | date:'medium' }}</span>
              </div>
            }

            @if (syncStatus) {
              <div class="sync-status">{{ syncStatus }}</div>
            }

            <div class="details-actions">
              <button class="btn btn-success" (click)="syncToMetabase()" [disabled]="!dataSource._id || loading">
                @if (loading) {
                  <span class="spinner"></span>
                }
                {{ loading ? 'Syncing...' : 'Sync to Metabase' }}
              </button>

              <button class="btn btn-outline" (click)="getDataSourceDetails()" [disabled]="!dataSource._id || loading">
                Refresh
              </button>
            </div>

            @if (metabaseInfo) {
              <div class="metabase-info">
                <h3>Metabase Info</h3>
                <div class="info-item">
                  <strong>ID:</strong> {{ metabaseInfo.id }}
                </div>
                <div class="info-item">
                  <strong>Name:</strong> {{ metabaseInfo.name }}
                </div>
                <div class="info-item">
                  <strong>Engine:</strong> {{ metabaseInfo.engine }}
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">
            <div class="empty-icon"></div>
        <p>Create a data source to see details here</p>
          </div>
        }
      </div>
    </div>
  </div>
</div>