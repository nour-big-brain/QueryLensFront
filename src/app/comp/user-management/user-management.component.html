<div class="container-fluid">
  <div class="search-section">
    <div class="search-bar">
      <input 
        type="text" 
        placeholder="Search..."
        [(ngModel)]="searchTerm"
        (input)="filterUsers()">
    </div>
    <div class="filter-buttons">
      <button class="filter-btn">
        <span>â‰¡</span>
      </button>
      <button class="sort-btn">
        <span>â¬‡ Sort: Last updated</span>
      </button>
    </div>
  </div>

  <!-- Success Message -->
  @if(successMessage) {
    <div class="alert alert-success alert-dismissible">
      {{ successMessage }}
      <button type="button" class="btn-close" (click)="successMessage = ''"></button>
    </div>
  }

  <!-- Error Message -->
  @if(error) {
    <div class="alert alert-danger alert-dismissible">
      {{ error }}
      <button type="button" class="btn-close" (click)="error = ''"></button>
    </div>
  }

  <!-- Loading State -->
  @if(loading) {
    <div class="loading-state">
      <div class="spinner-border spinner-border-sm"></div>
      Loading users...
    </div>
  }

  <!-- Users Table -->
  @if(!loading && filteredUsers.length > 0) {
    <div class="table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th class="id-col">ID</th>
            <th class="username-col">Username</th>
            <th class="email-col">Email</th>
            <th class="role-col">Role</th>
            <th class="status-col">Status</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for(user of filteredUsers; track user._id) {
            <tr [class.deleted]="user.deletedAt">
              <td class="id-col">{{ user.userId }}</td>
              <td class="username-col">
                <strong>{{ user.username }}</strong>
              </td>
              <td class="email-col">{{ user.email }}</td>
              <td class="role-col">
                <span class="role-badge">{{ getRoleName(user.roleId) }}</span>
              </td>
              <td class="status-col">
                <span [ngClass]="'status-badge ' + getStatusClass(user)">
                  {{ getStatusText(user) }}
                </span>
              </td>
              <td class="actions-col">
                <button 
                  class="action-btn assign-role-btn"
                  (click)="openRoleModal(user)"
                  [disabled]="actionInProgress === user._id"
                  title="Assign role">
                  ðŸ‘¤ Role
                </button>

                @if(user.isActive && !user.deletedAt) {
                  <button 
                    class="action-btn deactivate-btn"
                    (click)="deactivateUser(user._id, user.username)"
                    [disabled]="actionInProgress === user._id">
                    @if(actionInProgress === user._id) {
                      <span class="spinner-mini"></span>
                    } @else {
                      Deactivate
                    }
                  </button>
                }

                @if(!user.isActive && !user.deletedAt) {
                  <button 
                    class="action-btn activate-btn"
                    (click)="activateUser(user._id, user.username)"
                    [disabled]="actionInProgress === user._id">
                    @if(actionInProgress === user._id) {
                      <span class="spinner-mini"></span>
                    } @else {
                      Activate
                    }
                  </button>
                }

                @if(!user.deletedAt) {
                  <button 
                    class="action-btn delete-btn"
                    (click)="deleteUser(user._id, user.username)"
                    [disabled]="actionInProgress === user._id">
                    @if(actionInProgress === user._id) {
                      <span class="spinner-mini"></span>
                    } @else {
                      Delete
                    }
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- No Users Message -->
  @if(!loading && users.length === 0) {
    <div class="no-data">
      No users found
    </div>
  }

  <!-- No Search Results -->
  @if(!loading && users.length > 0 && filteredUsers.length === 0) {
    <div class="no-data">
      No users match your search: "<strong>{{ searchTerm }}</strong>"
    </div>
  }
</div>

<!-- Role Assignment Modal -->
@if(showRoleModal) {
  <div class="modal-overlay" (click)="closeRoleModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Assign Role</h3>
        <button class="modal-close" (click)="closeRoleModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <p class="modal-user">
          <strong>User:</strong> {{ selectedUserForRole?.username }}
        </p>

        <div class="form-group">
          <label for="roleSelect">Select Role:</label>
          <select 
            id="roleSelect"
            [(ngModel)]="selectedRoleId"
            class="form-control">
            <option value="">-- Choose a role --</option>
            @for(role of roles; track role._id) {
              <option [value]="role._id">{{ role.name }}</option>
            }
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button 
          class="btn btn-secondary"
          (click)="closeRoleModal()"
          [disabled]="assigningRole">
          Cancel
        </button>
        <button 
          class="btn btn-primary"
          (click)="assignRole()"
          [disabled]="assigningRole || !selectedRoleId">
          @if(assigningRole) {
            <span class="spinner-mini"></span> Assigning...
          } @else {
            Assign Role
          }
        </button>
      </div>
    </div>
  </div>
}