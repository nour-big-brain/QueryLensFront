<div *ngIf="isLoading" class="loading-container">
  <p>Loading dashboard...</p>
</div>

<div *ngIf="!isLoading && dashboardData" class="dashboard-full-layout">
  <div class="dashboard-main">
    <div class="dashboard-header">
      <div class="header-top">
        <div class="header-info">
          <h2>{{ dashboardData.name }}</h2>
          <p>{{ dashboardData.description }}</p>
          <small>Owner: {{ dashboardData.ownerName }} | {{ dashboardData.updatedAt | date:'short' }}</small>
          <div class="permission-badge permission-{{ permission }}">{{ getPermissionBadge() }}</div>
        </div>
        <div class="header-buttons">
          <button class="share-btn" (click)="openShareModal()" [disabled]="!canShare()">Share</button>
          <button class="toggle-sidebar-btn" (click)="toggleCommentsSidebar()">
            {{ showCommentsSidebar ? 'Hide' : 'Show' }} ðŸ’¬
          </button>
        </div>
      </div>
    </div>

    <ng-container *ngIf="chartData.length; else noCharts">
      <gridster [options]="options" class="gridster-wrapper" (itemChange)="onItemChange()">
        <gridster-item *ngFor="let data of chartData" [item]="data.item">
          <div class="chart-container" [class.drag-handle]="canEdit()">
            <div class="chart-header">
              <h3>{{ data.chart.title }}</h3>
              <span class="resize-handle" *ngIf="canEdit()">â¤¡</span>
            </div>
            <p class="chart-description" *ngIf="data.chart.description">{{ data.chart.description }}</p>
            <div class="chart-content">
              <ng-container [ngSwitch]="data.chart.type">
                <app-area-chart *ngSwitchCase="'area'" [payload]="data.chart"></app-area-chart>
                <app-bar-chart *ngSwitchCase="'bar'" [payload]="data.chart"></app-bar-chart>
                <app-line-chart *ngSwitchCase="'line'" [payload]="data.chart"></app-line-chart>
                <app-pie-chart *ngSwitchCase="'pie'" [payload]="data.chart"></app-pie-chart>
                <app-donut-chart *ngSwitchCase="'donut'" [payload]="data.chart"></app-donut-chart>
                <app-radar-chart *ngSwitchCase="'radar'" [payload]="data.chart"></app-radar-chart>
                <app-heatmap-chart *ngSwitchCase="'heatmap'" [payload]="data.chart"></app-heatmap-chart>
                <app-scatter-chart *ngSwitchCase="'scatter'" [payload]="data.chart"></app-scatter-chart>
                <app-mixed-chart *ngSwitchCase="'mixed'" [payload]="data.chart"></app-mixed-chart>
                <div *ngSwitchDefault>Unknown chart type: {{ data.chart.type }}</div>
              </ng-container>
            </div>
          </div>
        </gridster-item>
      </gridster>
    </ng-container>

    <ng-template #noCharts>
      <div class="no-charts-container"><p>No charts in this dashboard yet.</p></div>
    </ng-template>
  </div>

  <!-- Comments Sidebar -->
  <div class="comments-sidebar" *ngIf="showCommentsSidebar">
    <div class="comments-header">
      <h3>ðŸ’¬ Comments ({{ comments.length }})</h3>
    </div>

    <div class="comments-scroll">
      <div *ngIf="!commentsLoading && comments && comments.length > 0; else noComments">
        <div *ngFor="let comment of comments" class="comment-message">
          <div class="comment-avatar">{{ comment.username.charAt(0).toUpperCase() }}</div>
          <div class="comment-body">
            <div class="comment-author">
              <strong>{{ comment.username }}</strong>
              <span class="comment-time">{{ comment.createdAt | date:'short' }}</span>
              <button 
                *ngIf="comment.userId === currentUserId" 
                class="btn-delete-comment" 
                (click)="deleteComment(comment._id)"
              >
                âœ•
              </button>
            </div>
            <p class="comment-text">{{ comment.text }}</p>
          </div>
        </div>
      </div>
      <ng-template #noComments>
        <div class="no-comments-yet">
          <p *ngIf="!commentsLoading">No comments yet. Be the first!</p>
          <p *ngIf="commentsLoading">Loading...</p>
        </div>
      </ng-template>
    </div>

    <div class="comment-input-section">
      <label class="input-label">Add a comment</label>
      <div class="input-group">
        <input 
          type="text" 
          [(ngModel)]="newComment" 
          placeholder="Type something..."
          class="comment-input"
          (keyup.enter)="addComment()"
        />
        <button class="btn-send" (click)="addComment()" [disabled]="!newComment.trim()">Send</button>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div class="modal-overlay" *ngIf="showShareModal" (click)="closeShareModal()">
    <div class="share-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Share Dashboard</h3>
        <button class="close-btn" (click)="closeShareModal()">âœ•</button>
      </div>

      <div class="modal-body">
        <p>Share "<strong>{{ dashboardData.name }}</strong>" with another user:</p>

        <div class="form-group">
          <label>Username or User ID</label>
          <input 
            type="text" 
            [(ngModel)]="targetUsernameOrId" 
            placeholder="e.g. john_doe or 6910cda02f1185a181e3e542"
            class="share-input"
          />
        </div>

        <div class="form-group">
          <label>Permission Level</label>
          <select [(ngModel)]="sharePermission">
            <option value="view">View only</option>
            <option value="edit">Can edit</option>
            <option value="admin">Full access</option>
          </select>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" (click)="closeShareModal()">Cancel</button>
          <button class="btn-share" (click)="confirmShare()" [disabled]="!targetUsernameOrId.trim()">
            Share Dashboard
          </button>
        </div>

        <div *ngIf="shareMessage" class="share-status" [ngClass]="shareSuccess ? 'success' : 'error'">
          {{ shareMessage }}
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!isLoading && !dashboardData" class="error-container">
  <p>Dashboard not found or failed to load.</p>
</div>